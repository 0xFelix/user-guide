<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://kubevirt.io/docs/operations/vmctl/">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Vmctl - KubeVirt User-Guide</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Vmctl";
    var mkdocs_page_input_path = "operations/vmctl.md";
    var mkdocs_page_url = "/docs/operations/vmctl/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> KubeVirt User-Guide</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../welcome/">Welcome</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../latest_release_notes/">Latest release notes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Operations</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../updating_and_deletion/">Updating and deletion</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../basic_use/">Basic use</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api_validation/">API Validation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../virtctl_client_tool/">virtctl Client Tool</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../live_migration/">Live Migration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../hugepages/">Hugepages support</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../component_monitoring/">Component monitoring</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../authorization/">Authorization</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../annotations_and_labels/">Annotations and labels</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../node_assignment/">Node assignment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../node_maintenance/">Node maintenance</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../node_overcommit/">Node overcommit</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../unresponsive_nodes/">Unresponsive nodes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../virtualmachineinstance_node_eviction/">VirtualMachineInstance Node Eviction</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Vmctl</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#background">Background</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#services">Services</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#persistentvolumeclaims">PersistentVolumeClaims</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#deployment">Deployment</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#daemonset">Daemonset</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#service">Service</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../containerized_data_importer/">Containerized Data Importer</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Virtual machines</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/virtual_machine_instances/">Virtual Machines Instances</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/lifecycle/">Lifecycle</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/run_strategies/">Run Strategies</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/presets/">Presets</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/virtual_hardware/">Virtual hardware</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/dedicated_cpu_resources/">Dedicated CPU resources</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/disks_and_volumes/">Disks and Volumes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/interfaces_and_networks/">Interfaces and Networks</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/networkpolicy/">NetworkPolicy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/host-devices/">Host Devices Assignment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/windows_wirtio_drivers/">Windows virtio drivers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/guest_operating_system_information/">Guest Operating System Information</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/guest_agent_information/">Guest Agent information</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/liveness_and_readiness_probes/">Liveness and Readiness Probes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/graphical_and_console_access/">Graphical and Serial Console Access</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/startup_scripts/">Startup Scripts</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/service_objects/">Service object</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/templates/">Templates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/replicaset/">VirtualMachineInstanceReplicaSet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../virtual_machines/dns/">DNS records</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../web_console/">Web Console</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Appendix</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../appendix/contributing/">Contributing</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">KubeVirt User-Guide</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Operations &raquo;</li>
        
      
    
    <li>Vmctl</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/kubevirt/user-guide/edit/master/docs/operations/vmctl.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="vmctl">Vmctl<a class="headerlink" href="#vmctl" title="Permanent link">&para;</a></h1>
<h2 id="background">Background<a class="headerlink" href="#background" title="Permanent link">&para;</a></h2>
<p>One remarkable difference between KubeVirt and other solutions that run
Virtual Machine workloads in a container is the toplevel API. KubeVirt
treats VirtualMachineInstances as a first class citizen by designating
custom resources to map/track VirtualMachine settings and attributes.
This has considerable advantages, but there’s a trade-off: native
Kubernetes higher-level workload controllers such as Deployments,
ReplicaSets, DaemonSets, StatefulSets are designed to work directly with
Pods. Because VirtualMachine and VirtualMachineInstance resources are
simply defined outside the scope of Kubernetes responsibility, it will
always be up to the KubeVirt project to create analogues of those
controllers. This is possible, and is in fact something that exists for
some entities, e.g. VirtualMachineInstanceReplicaSet, but the KubeVirt
project will always be one step behind. Any significant changes upstream
would need to be implemented manually in KubeVirt.</p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>Vmctl is designed to address this delta by managing VirtualMachines from
within a Pod. Vmctl will take an upstream VirtualMachine to act as a
prototype and derive and spawn a new VirtualMachine based on it. This
derived VM will be running alongside the vmctl pod. Thus for every vmctl
pod in the cluster, there should be a VM running alongside of it. To be
clear, vmctl is not a VM instead it is controlling a VM close by. The
derived VM will be similar to the prototype, but a few fields will be
modified:</p>
<ul>
<li>Name</li>
<li>NodeSelector</li>
<li>Running</li>
</ul>
<h3 id="name">Name<a class="headerlink" href="#name" title="Permanent link">&para;</a></h3>
<p>The new VirtualMachine’s <code>Name</code> attribute will be a concatenation of the
prototype VM’s name and the Pod’s name. This will be a unique resource
name because both the prototype VM name and the vmctl Pod name are
unique.</p>
<h3 id="nodeselector">NodeSelector<a class="headerlink" href="#nodeselector" title="Permanent link">&para;</a></h3>
<p>The new VirtualMachine will have a selector with node affinity matching
the running vmctl Pod’s node, thus the VirtualMachine and the vmctl Pod
will run on the same node. This is because a <code>DaemonSet</code> maps one pod to
each node in a cluster. By tracking which Node a vmctl Pod is running
on, KubeVirt ensures the same behavior for VirtualMachines.</p>
<h3 id="running">Running<a class="headerlink" href="#running" title="Permanent link">&para;</a></h3>
<p>The new VirtualMachine will be set to the running state regardless of
the prototype VM’s state.</p>
<h2 id="implementation">Implementation<a class="headerlink" href="#implementation" title="Permanent link">&para;</a></h2>
<p>Vmctl is implemented as a go binary, deployed in a container, that takes
the following parameters:</p>
<ul>
<li><code>namespace</code>: The namespace to create the derived VirtualMachine in.
    The default namespace is <code>default</code>.</li>
<li><code>proto-namespace</code>: The namespace the prototype VM is in. This
    defaults to the value used for <code>namespace</code> if omitted.</li>
<li><code>hostname-override</code>: Mainly for testing–in order to make it possible
    to run vmctl outside of a pod.</li>
</ul>
<p>vmctl has a single positional argument:</p>
<ul>
<li>prototype VM name</li>
</ul>
<p>When the vmctl container is deployed, it will locate the requested
prototype VM, clone it, and watch wait. When the vmctl pod is deleted,
vmctl will clean up the derived VirtualMachine. Consequently it is
inadvisable to use a 0 length grace period for shutting down the pod.</p>
<h2 id="services">Services<a class="headerlink" href="#services" title="Permanent link">&para;</a></h2>
<p>One note worth stressing is that from Kubernetes's perspective the vmctl
Pod is entirely distinct from the VM it spawns. It is especially
important to be mindful of this when creating services. From an end
user’s perspective, there’s nothing useful running on the vmctl Pod
itself. The recommended method of exposing services on a VM is to use
Labels and Selectors. Applying a label to the prototype VM, and using
that <code>matchLabel</code> on a service is sufficient to expose the service on
all derived VM’s.</p>
<h2 id="persistentvolumeclaims">PersistentVolumeClaims<a class="headerlink" href="#persistentvolumeclaims" title="Permanent link">&para;</a></h2>
<p>Another thing to consider with vmctl is the use of shared volumes. By
nature vmctl is designed to spawn an arbitrary number of VirtualMachines
on demand, all of which will define the same Disk and Volume stanzas.
Because of this, using shared volumes in read-write mode should be
avoided, or the PVC’s could be corrupted. To avoid this issue, ephemeral
disks or ContainerDisks could be used.</p>
<h2 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h2>
<p>The following PodPreset applies to all examples below. This is done to
remove lines that are related to the Kubernetes DownwardAPI in order to
make the examples more clear.</p>
<pre><code>apiVersion: settings.k8s.io/v1alpha1
kind: PodPreset
metadata:
  name: have-podinfo
  selector:
    matchLabels:
      app: vmctl
spec:
  volumeMounts:
    - name: podinfo
      mountPath: /etc/podinfo
  volumes:
    - name: podinfo
      downwardAPI:
        items:
        - path: "name"
          fieldRef:
            fieldPath: metadata.name
</code></pre>
<h2 id="deployment">Deployment<a class="headerlink" href="#deployment" title="Permanent link">&para;</a></h2>
<p>This is an example of using vmctl as a Deployment (Note: this example
uses the <code>have-podinfo</code> PodPreset above):</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: vmctl
  labels:
    app: vmctl
spec:
  replicas: 3
  selector:
    matchLabels:
      app: vmctl
  template:
    metadata:
      labels:
        app: vmctl
    spec:
      containers:
      - name: vmctl
        image: quay.io/fabiand/vmctl
        imagePullPolicy: IfNotPresent
        args:
        - "testvm"
        serviceAccountName: default
</code></pre>
<p>This example would look for a VirtualMachine in the <code>default</code> namespace
named <code>testvm</code>, and instantiate 3 replicas of it.</p>
<h2 id="daemonset">Daemonset<a class="headerlink" href="#daemonset" title="Permanent link">&para;</a></h2>
<p>This is an example of using vmctl as a Daemonset (Note: this example
uses the <code>have-podinfo</code> PodPreset above):</p>
<pre><code>apiVersion: apps/v1
kind: Daemonset
metadata:
  name: vmctl
  labels:
    app: vmctl
spec:
  selector:
    matchLabels:
      app: vmctl
  template:
    metadata:
      labels:
        app: vmctl
    spec:
      containers:
      - name: vmctl
        image: quay.io/fabiand/vmctl
        imagePullPolicy: IfNotPresent
        args:
        - "testvm"
        serviceAccountName: default
</code></pre>
<p>This example would look for a VirtualMachine in the <code>default</code> namespace
named <code>testvm</code>, and instantiate a VirtualMachine on every node in the
Kubernetes cluster.</p>
<h2 id="service">Service<a class="headerlink" href="#service" title="Permanent link">&para;</a></h2>
<p>Assuming a controller similar to the examples above, where a label
<code>app: vmctl</code> is used, a service to expose the VM’s could look like this:</p>
<pre><code>kind: Service
apiVersion: v1
metadata:
  name: my-service
spec:
  selector:
    app: vmctl
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
</code></pre>
<p>In this case a clusterIP would be created that maps port 80 to each VM.
See <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes
Services</a>
for more information.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../containerized_data_importer/" class="btn btn-neutral float-right" title="Containerized Data Importer">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../virtualmachineinstance_node_eviction/" class="btn btn-neutral" title="VirtualMachineInstance Node Eviction"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/kubevirt/user-guide/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../virtualmachineinstance_node_eviction/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../containerized_data_importer/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
