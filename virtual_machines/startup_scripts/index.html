<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://kubevirt.io/user-guide/virtual_machines/startup_scripts/">
  <link rel="shortcut icon" href="../../assets/favicon.ico">
  
  <title>Startup Scripts - KubeVirt User-Guide</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Startup Scripts";
    var mkdocs_page_input_path = "virtual_machines/startup_scripts.md";
    var mkdocs_page_url = "/user-guide/virtual_machines/startup_scripts/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> KubeVirt User-Guide</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Welcome</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../latest_release_notes/">Latest release notes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Operations</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/installation/">Installation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/updating_and_deletion/">Updating and deletion</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/basic_use/">Basic use</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/api_validation/">API Validation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/virtctl_client_tool/">virtctl Client Tool</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/live_migration/">Live Migration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/hugepages/">Hugepages support</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/component_monitoring/">Component monitoring</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/authorization/">Authorization</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/annotations_and_labels/">Annotations and labels</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/node_assignment/">Node assignment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/node_maintenance/">Node maintenance</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/node_overcommit/">Node overcommit</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/unresponsive_nodes/">Unresponsive nodes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/containerized_data_importer/">Containerized Data Importer</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operations/activating_feature_gates/">Activating feature gates</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Virtual machines</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../virtual_machine_instances/">Virtual Machines Instances</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../lifecycle/">Lifecycle</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../run_strategies/">Run Strategies</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../presets/">Presets</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../virtual_hardware/">Virtual hardware</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dedicated_cpu_resources/">Dedicated CPU resources</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../disks_and_volumes/">Disks and Volumes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../interfaces_and_networks/">Interfaces and Networks</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../networkpolicy/">NetworkPolicy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../host-devices/">Host Devices Assignment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../windows_virtio_drivers/">Windows virtio drivers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../guest_operating_system_information/">Guest Operating System Information</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../guest_agent_information/">Guest Agent information</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../liveness_and_readiness_probes/">Liveness and Readiness Probes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../accessing_virtual_machines/">Accessing Virtual Machines</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Startup Scripts</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#cloud-init">Cloud-init</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sysprep">Sysprep</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cloud-init-examples">Cloud-init Examples</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sysprep-examples">Sysprep Examples</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../service_objects/">Service objects</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../templates/">Templates</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../replicaset/">VirtualMachineInstanceReplicaSet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dns/">DNS records</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../web_console/">Web Console</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Appendix</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../appendix/contributing/">Contributing</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">KubeVirt User-Guide</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Virtual machines &raquo;</li>
        
      
    
    <li>Startup Scripts</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/kubevirt/user-guide/edit/master/docs/virtual_machines/startup_scripts.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="startup-scripts">Startup Scripts<a class="headerlink" href="#startup-scripts" title="Permanent link">&para;</a></h1>
<p>KubeVirt supports the ability to assign a startup script to a
VirtualMachineInstance instance which is executed automatically when the
VM initializes.</p>
<p>These scripts are commonly used to automate injection of users and SSH
keys into VMs in order to provide remote access to the machine. For
example, a startup script can be used to inject credentials into a VM
that allows an Ansible job running on a remote host to access and
provision the VM.</p>
<p>Startup scripts are not limited to any specific use case though. They
can be used to run any arbitrary script in a VM on boot.</p>
<h2 id="cloud-init">Cloud-init<a class="headerlink" href="#cloud-init" title="Permanent link">&para;</a></h2>
<p>cloud-init is a widely adopted project used for early initialization of
a VM. Used by cloud providers such as AWS and GCP, cloud-init has
established itself as the defacto method of providing startup scripts to
VMs.</p>
<p>Cloud-init documentation can be found here: <a href="https://cloudinit.readthedocs.io/en/latest/">Cloud-init
Documentation</a>.</p>
<p>KubeVirt supports cloud-init's "NoCloud" and "ConfigDrive" datasources
which involve injecting startup scripts into a VM instance through the
use of an ephemeral disk. VMs with the cloud-init package installed will
detect the ephemeral disk and execute custom userdata scripts at boot.</p>
<h2 id="sysprep">Sysprep<a class="headerlink" href="#sysprep" title="Permanent link">&para;</a></h2>
<p>Sysprep is an automation tool for Windows that automates Windows
installation, setup, and custom software provisioning.</p>
<p>The general flow is:</p>
<ol>
<li>
<p>Seal the vm image with the Sysprep tool, for example by running:</p>
<pre><code>%WINDIR%\system32\sysprep\sysprep.exe /generalize /shutdown /oobe /mode:vm
</code></pre>
<p>More information can be found here:
* <a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/sysprep-process-overview">Sysprep Process Overview</a>
* <a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/sysprep--generalize--a-windows-installation">Sysprep (Generalize) a Windows installation</a></p>
</li>
<li>
<p>Providing an Answer file named <code>autounattend.xml</code> in an attached media. The answer file can be provided in a ConfigMap or a Secret with the key <code>autounattend.xml</code></p>
<p>More information can be found here: <a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/update-windows-settings-and-scripts-create-your-own-answer-file-sxs">Answer files (unattend.xml)</a></p>
<p>Note that there are also many easy to find online tools available for creating an answer file.</p>
</li>
</ol>
<h2 id="cloud-init-examples">Cloud-init Examples<a class="headerlink" href="#cloud-init-examples" title="Permanent link">&para;</a></h2>
<h3 id="user-data">User Data<a class="headerlink" href="#user-data" title="Permanent link">&para;</a></h3>
<p>KubeVirt supports the cloud-init NoCloud and ConfigDrive data sources
which involve injecting startup scripts through the use of a disk
attached to the VM.</p>
<p>In order to assign a custom userdata script to a VirtualMachineInstance
using this method, users must define a disk and a volume for the NoCloud
or ConfigDrive datasource in the VirtualMachineInstance's spec.</p>
<h4 id="data-sources">Data Sources<a class="headerlink" href="#data-sources" title="Permanent link">&para;</a></h4>
<p>Under most circumstances users should stick to the NoCloud data source
as it is the simplest cloud-init data source. Only if NoCloud is not
supported by the cloud-init implementation (e.g.
<a href="https://github.com/coreos/coreos-cloudinit">coreos-cloudinit</a>) users
should switch the data source to ConfigDrive.</p>
<p>Switching the cloud-init data source to ConfigDrive is as easy as
changing the volume type in the VirtualMachineInstance's spec from
<code>cloudInitNoCloud</code> to <code>cloudInitConfigDrive</code>.</p>
<p>NoCloud data source:</p>
<pre><code>volumes:
  - name: cloudinitvolume
    cloudInitNoCloud:
      userData: "#cloud-config"
</code></pre>
<p>ConfigDrive data source:</p>
<pre><code>volumes:
  - name: cloudinitvolume
    cloudInitConfigDrive:
      userData: "#cloud-config"
</code></pre>
<p>See the examples below for more complete cloud-init examples.</p>
<h4 id="cloud-init-user-data-as-clear-text">Cloud-init user-data as clear text<a class="headerlink" href="#cloud-init-user-data-as-clear-text" title="Permanent link">&para;</a></h4>
<p>In the example below, a SSH key is stored in the cloudInitNoCloud
Volume's userData field as clean text. There is a corresponding disks
entry that references the cloud-init volume and assigns it to the VM's
device.</p>
<pre><code># Create a VM manifest with the startup script
# a cloudInitNoCloud volume's userData field.

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        disk:
          bus: virtio
      - name: cloudinitdisk
        disk:
          bus: virtio
  volumes:
    - name: containerdisk
      containerDisk:
        image: kubevirt/cirros-container-disk-demo:latest
    - name: cloudinitdisk
      cloudInitNoCloud:
        userData: |
          ssh_authorized_keys:
            - ssh-rsa AAAAB3NzaK8L93bWxnyp test@test.com

END

# Post the Virtual Machine spec to KubeVirt.

kubectl create -f my-vmi.yaml
</code></pre>
<h4 id="cloud-init-user-data-as-base64-string">Cloud-init user-data as base64 string<a class="headerlink" href="#cloud-init-user-data-as-base64-string" title="Permanent link">&para;</a></h4>
<p>In the example below, a simple bash script is base64 encoded and stored
in the cloudInitNoCloud Volume's userDataBase64 field. There is a
corresponding disks entry that references the cloud-init volume and
assigns it to the VM's device.</p>
<p><em>Users also have the option of storing the startup script in a
Kubernetes Secret and referencing the Secret in the VM's spec. Examples
further down in the document illustrate how that is done.</em></p>
<pre><code># Create a simple startup script

cat &lt;&lt; END &gt; startup-script.sh
#!/bin/bash
echo "Hi from startup script!"
END

# Create a VM manifest with the startup script base64 encoded into
# a cloudInitNoCloud volume's userDataBase64 field.

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        disk:
          bus: virtio
      - name: cloudinitdisk
        disk:
          bus: virtio
  volumes:
    - name: containerdisk
      containerDisk:
        image: kubevirt/cirros-container-disk-demo:latest
    - name: cloudinitdisk
      cloudInitNoCloud:
        userDataBase64: $(cat startup-script.sh | base64 -w0)
END

# Post the Virtual Machine spec to KubeVirt.

kubectl create -f my-vmi.yaml
</code></pre>
<h4 id="cloud-init-userdata-as-k8s-secret">Cloud-init UserData as k8s Secret<a class="headerlink" href="#cloud-init-userdata-as-k8s-secret" title="Permanent link">&para;</a></h4>
<p>Users who wish to not store the cloud-init userdata directly in the
VirtualMachineInstance spec have the option to store the userdata into a
Kubernetes Secret and reference that Secret in the spec.</p>
<p>Multiple VirtualMachineInstance specs can reference the same Kubernetes
Secret containing cloud-init userdata.</p>
<p>Below is an example of how to create a Kubernetes Secret containing a
startup script and reference that Secret in the VM's spec.</p>
<pre><code># Create a simple startup script

cat &lt;&lt; END &gt; startup-script.sh
#!/bin/bash
echo "Hi from startup script!"
END

# Store the startup script in a Kubernetes Secret
kubectl create secret generic my-vmi-secret --from-file=userdata=startup-script.sh

# Create a VM manifest and reference the Secret's name in the cloudInitNoCloud
# Volume's secretRef field

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        disk:
          bus: virtio
      - name: cloudinitdisk
        disk:
          bus: virtio
  volumes:
    - name: containerdisk
      containerDisk:
        image: kubevirt/cirros-registry-disk-demo:latest
    - name: cloudinitdisk
      cloudInitNoCloud:
        secretRef:
          name: my-vmi-secret
END

# Post the VM
kubectl create -f my-vmi.yaml
</code></pre>
<h4 id="injecting-ssh-keys-with-cloud-inits-cloud-config">Injecting SSH keys with Cloud-init's Cloud-config<a class="headerlink" href="#injecting-ssh-keys-with-cloud-inits-cloud-config" title="Permanent link">&para;</a></h4>
<p>In the examples so far, the cloud-init userdata script has been a bash
script. Cloud-init has it's own configuration that can handle some
common tasks such as user creation and SSH key injection.</p>
<p>More cloud-config examples can be found here: <a href="https://cloudinit.readthedocs.io/en/latest/topics/examples.html">Cloud-init
Examples</a></p>
<p>Below is an example of using cloud-config to inject an SSH key for the
default user (fedora in this case) of a <a href="https://www.projectatomic.io/">Fedora Atomic</a> disk image.</p>
<pre><code># Create the cloud-init cloud-config userdata.
cat &lt;&lt; END &gt; startup-script
#cloud-config
password: atomic
chpasswd: { expire: False }
ssh_pwauth: False
ssh_authorized_keys:
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6zdgFiLr1uAK7PdcchDd+LseA5fEOcxCCt7TLlr7Mx6h8jUg+G+8L9JBNZuDzTZSF0dR7qwzdBBQjorAnZTmY3BhsKcFr8Gt4KMGrS6r3DNmGruP8GORvegdWZuXgASKVpXeI7nCIjRJwAaK1x+eGHwAWO9Z8ohcboHbLyffOoSZDSIuk2kRIc47+ENRjg0T6x2VRsqX27g6j4DfPKQZGk0zvXkZaYtr1e2tZgqTBWqZUloMJK8miQq6MktCKAS4VtPk0k7teQX57OGwD6D7uo4b+Cl8aYAAwhn0hc0C2USfbuVHgq88ESo2/+NwV4SQcl3sxCW21yGIjAGt4Hy7J fedora@localhost.localdomain
END

# Create the VM spec
cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: sshvmi
spec:
  terminationGracePeriodSeconds: 0
  domain:
    resources:
      requests:
        memory: 1024M
    devices:
      disks:
      - name: containerdisk
        disk:
          dev: vda
      - name: cloudinitdisk
        disk:
          dev: vdb
  volumes:
    - name: containerdisk
      containerDisk:
        image: kubevirt/fedora-atomic-registry-disk-demo:latest
    - name: cloudinitdisk
      cloudInitNoCloud:
        userDataBase64: $(cat startup-script | base64 -w0)
END

# Post the VirtualMachineInstance spec to KubeVirt.
kubectl create -f my-vmi.yaml

# Connect to VM with passwordless SSH key
ssh -i &lt;insert private key here&gt; fedora@&lt;insert ip here&gt;
</code></pre>
<h4 id="inject-ssh-key-using-a-custom-shell-script">Inject SSH key using a Custom Shell Script<a class="headerlink" href="#inject-ssh-key-using-a-custom-shell-script" title="Permanent link">&para;</a></h4>
<p>Depending on the boot image in use, users may have a mixed experience
using cloud-init's cloud-config to create users and inject SSH keys.</p>
<p>Below is an example of creating a user and injecting SSH keys for that
user using a script instead of cloud-config.</p>
<pre><code>cat &lt;&lt; END &gt; startup-script.sh
#!/bin/bash
export NEW_USER="foo"
export SSH_PUB_KEY="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6zdgFiLr1uAK7PdcchDd+LseA5fEOcxCCt7TLlr7Mx6h8jUg+G+8L9JBNZuDzTZSF0dR7qwzdBBQjorAnZTmY3BhsKcFr8Gt4KMGrS6r3DNmGruP8GORvegdWZuXgASKVpXeI7nCIjRJwAaK1x+eGHwAWO9Z8ohcboHbLyffOoSZDSIuk2kRIc47+ENRjg0T6x2VRsqX27g6j4DfPKQZGk0zvXkZaYtr1e2tZgqTBWqZUloMJK8miQq6MktCKAS4VtPk0k7teQX57OGwD6D7uo4b+Cl8aYAAwhn0hc0C2USfbuVHgq88ESo2/+NwV4SQcl3sxCW21yGIjAGt4Hy7J $NEW_USER@localhost.localdomain"

sudo adduser -U -m $NEW_USER
echo "$NEW_USER:atomic" | chpasswd
sudo mkdir /home/$NEW_USER/.ssh
sudo echo "$SSH_PUB_KEY" &gt; /home/$NEW_USER/.ssh/authorized_keys
sudo chown -R ${NEW_USER}: /home/$NEW_USER/.ssh
END

# Create the VM spec
cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachineInstance
metadata:
  name: sshvmi
spec:
  terminationGracePeriodSeconds: 0
  domain:
    resources:
      requests:
        memory: 1024M
    devices:
      disks:
      - name: containerdisk
        disk:
          dev: vda
      - name: cloudinitdisk
        disk:
          dev: vdb
  volumes:
    - name: containerdisk
      containerDisk:
        image: kubevirt/fedora-atomic-registry-disk-demo:latest
    - name: cloudinitdisk
      cloudInitNoCloud:
        userDataBase64: $(cat startup-script.sh | base64 -w0)
END

# Post the VirtualMachineInstance spec to KubeVirt.
kubectl create -f my-vmi.yaml

# Connect to VM with passwordless SSH key
ssh -i &lt;insert private key here&gt; foo@&lt;insert ip here&gt;
</code></pre>
<h3 id="network-config">Network Config<a class="headerlink" href="#network-config" title="Permanent link">&para;</a></h3>
<p>A cloud-init <a href="https://cloudinit.readthedocs.io/en/latest/topics/network-config-format-v1.html">network version
1</a>
configuration can be set to configure the network at boot.</p>
<p>Cloud-init <a href="#user-data">user-data</a> <strong>must</strong> be set for cloud-init to
parse <em>network-config</em> even if it is just the user-data config header:</p>
<pre><code>#cloud-config
</code></pre>
<h4 id="cloud-init-network-config-as-clear-text">Cloud-init network-config as clear text<a class="headerlink" href="#cloud-init-network-config-as-clear-text" title="Permanent link">&para;</a></h4>
<p>In the example below, a simple cloud-init network-config is stored in
the cloudInitNoCloud Volume's networkData field as clean text. There is
a corresponding disks entry that references the cloud-init volume and
assigns it to the VM's device.</p>
<pre><code># Create a VM manifest with the network-config in
# a cloudInitNoCloud volume's networkData field.

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          bus: virtio
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          bus: virtio
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/cirros-container-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        userData: "#cloud-config"
        networkData: |
          network:
            version: 1
            config:
            - type: physical
            name: eth0
            subnets:
              - type: dhcp

END

# Post the Virtual Machine spec to KubeVirt.

kubectl create -f my-vmi.yaml
</code></pre>
<h4 id="cloud-init-network-config-as-base64-string">Cloud-init network-config as base64 string<a class="headerlink" href="#cloud-init-network-config-as-base64-string" title="Permanent link">&para;</a></h4>
<p>In the example below, a simple network-config is base64 encoded and
stored in the cloudInitNoCloud Volume's networkDataBase64 field. There
is a corresponding disks entry that references the cloud-init volume and
assigns it to the VM's device.</p>
<p><em>Users also have the option of storing the network-config in a
Kubernetes Secret and referencing the Secret in the VM's spec. Examples
further down in the document illustrate how that is done.</em></p>
<pre><code># Create a simple network-config

cat &lt;&lt; END &gt; network-config
network:
  version: 1
  config:
  - type: physical
  name: eth0
  subnets:
    - type: dhcp
END

# Create a VM manifest with the networkData base64 encoded into
# a cloudInitNoCloud volume's networkDataBase64 field.

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          bus: virtio
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          bus: virtio
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/cirros-container-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        userData: "#cloud-config"
        networkDataBase64: $(cat network-config | base64 -w0)
END

# Post the Virtual Machine spec to KubeVirt.

kubectl create -f my-vmi.yaml
</code></pre>
<h4 id="cloud-init-network-config-as-k8s-secret">Cloud-init network-config as k8s Secret<a class="headerlink" href="#cloud-init-network-config-as-k8s-secret" title="Permanent link">&para;</a></h4>
<p>Users who wish to not store the cloud-init network-config directly in
the VirtualMachineInstance spec have the option to store the
network-config into a Kubernetes Secret and reference that Secret in the
spec.</p>
<p>Multiple VirtualMachineInstance specs can reference the same Kubernetes
Secret containing cloud-init network-config.</p>
<p>Below is an example of how to create a Kubernetes Secret containing a
network-config and reference that Secret in the VM's spec.</p>
<pre><code># Create a simple network-config

cat &lt;&lt; END &gt; network-config
network:
  version: 1
  config:
  - type: physical
  name: eth0
  subnets:
    - type: dhcp
END

# Store the network-config in a Kubernetes Secret
kubectl create secret generic my-vmi-secret --from-file=networkdata=network-config

# Create a VM manifest and reference the Secret's name in the cloudInitNoCloud
# Volume's secretRef field

cat &lt;&lt; END &gt; my-vmi.yaml
apiVersion: kubevirt.io/v1alpha2
kind: VirtualMachineInstance
metadata:
  name: myvmi
spec:
  terminationGracePeriodSeconds: 5
  domain:
    resources:
      requests:
        memory: 64M
    devices:
      disks:
      - name: containerdisk
        volumeName: registryvolume
        disk:
          bus: virtio
      - name: cloudinitdisk
        volumeName: cloudinitvolume
        disk:
          bus: virtio
  volumes:
    - name: registryvolume
      containerDisk:
        image: kubevirt/cirros-registry-disk-demo:latest
    - name: cloudinitvolume
      cloudInitNoCloud:
        userData: "#cloud-config"
        networkDataSecretRef:
          name: my-vmi-secret
END

# Post the VM
kubectl create -f my-vmi.yaml
</code></pre>
<h3 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link">&para;</a></h3>
<p>Depending on the operating system distribution in use, cloud-init output
is often printed to the console output on boot up. When developing
userdata scripts, users can connect to the VM's console during boot up
to debug.</p>
<p>Example of connecting to console using virtctl:</p>
<pre><code>virtctl console &lt;name of vmi&gt;
</code></pre>
<h3 id="device-role-tagging">Device Role Tagging<a class="headerlink" href="#device-role-tagging" title="Permanent link">&para;</a></h3>
<p>KubeVirt provides a mechanism for users to tag devices such as Network
Interfaces with a specific role. The tag will be matched to the hardware
address of the device and this mapping exposed to the guest OS via
cloud-init.</p>
<p>This additional metadata will help the guest OS users with multiple networks
interfaces to identify the devices that may have a specific role, such as a
network device dedicated to a specific service or a disk intended to be used by
a specific application (database, webcache, etc.)</p>
<p>This functionality already exists in platforms such as OpenStack. KubeVirt will
provide the data in a similar format, known to users and services like cloud-init.</p>
<p>For example:</p>
<pre><code>kind: VirtualMachineInstance
spec:
  domain:
    devices:
      interfaces:
      - masquerade: {}
        name: default
      - bridge: {}
        name: ptp
    tag: ptp
      - name: sriov-net
        sriov: {}
        tag: nfvfunc
  networks:
  - name: default
    pod: {}
  - multus:
      networkName: ptp-conf
    name: ptp
      networkName: sriov/sriov-network
    name: sriov-net

The metadata will be available in the guests config drive `openstack/latest/meta_data.json`

{
  &quot;devices&quot;: [
    {
        &quot;type&quot;: &quot;nic&quot;,
        &quot;bus&quot;: &quot;pci&quot;,
        &quot;address&quot;: &quot;0000:00:02.0&quot;,
        &quot;mac&quot;: &quot;01:22:22:42:22:21&quot;,
        &quot;tags&quot;: [&quot;ptp&quot;]
    },
    {
        &quot;type&quot;: &quot;nic&quot;,
        &quot;bus&quot;: &quot;pci&quot;,
        &quot;address&quot;: &quot;0000:81:10.1&quot;,
        &quot;mac&quot;: &quot;01:22:22:42:22:22&quot;,
        &quot;tags&quot;: [&quot;nfvfunc&quot;]
    },
  ]
}
</code></pre>
<h2 id="sysprep-examples">Sysprep Examples<a class="headerlink" href="#sysprep-examples" title="Permanent link">&para;</a></h2>
<h3 id="sysprep-in-a-configmap">Sysprep in a ConfigMap<a class="headerlink" href="#sysprep-in-a-configmap" title="Permanent link">&para;</a></h3>
<p>The answer file can be provided in a ConfigMap:</p>
<pre><code class="language-console">apiVersion: v1
kind: ConfigMap
metadata:
  name: sysprep-config
data:
  autounattend.xml: |
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
    &lt;unattend xmlns=&quot;urn:schemas-microsoft-com:unattend&quot;&gt;
    ...
    &lt;/unattend&gt;
</code></pre>
<p>And attached to the VM like so:</p>
<pre><code class="language-console">kind: VirtualMachine
metadata:
  name: windows-with-sysprep
spec:
  running: false
  template:
    metadata:
      labels:
        kubevirt.io/domain: windows-with-sysprep
    spec:
      domain:
        cpu:
          cores: 3
        devices:
          disks:
          - bootOrder: 1
            disk:
              bus: virtio
            name: harddrive
          - name: sysprep
            cdrom:
              bus: sata
        machine:
          type: q35
        resources:
          requests:
            memory: 6G
      volumes:
      - name: harddrive
        persistentVolumeClaim:
          claimName: windows_pvc
      - name: sysprep
        sysprep:
          configMap:
            name: sysprep-config
</code></pre>
<h3 id="sysprep-in-a-secret">Sysprep in a Secret<a class="headerlink" href="#sysprep-in-a-secret" title="Permanent link">&para;</a></h3>
<p>The answer file can be provided in a Secret:</p>
<pre><code class="language-console">apiVersion: v1
kind: Secret
metadata:
  name: sysprep-config
stringData:
data:
  autounattend.xml: |
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
    &lt;unattend xmlns=&quot;urn:schemas-microsoft-com:unattend&quot;&gt;
    ...
    &lt;/unattend&gt;
</code></pre>
<p>And attached to the VM like so:</p>
<pre><code class="language-console">kind: VirtualMachine
metadata:
  name: windows-with-sysprep
spec:
  running: false
  template:
    metadata:
      labels:
        kubevirt.io/domain: windows-with-sysprep
    spec:
      domain:
        cpu:
          cores: 3
        devices:
          disks:
          - bootOrder: 1
            disk:
              bus: virtio
            name: harddrive
          - name: sysprep
            cdrom:
              bus: sata
        machine:
          type: q35
        resources:
          requests:
            memory: 6G
      volumes:
      - name: harddrive
        persistentVolumeClaim:
          claimName: windows_pvc
      - name: sysprep
        sysprep:
          secret:
            name: sysprep-secret
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../service_objects/" class="btn btn-neutral float-right" title="Service objects">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../accessing_virtual_machines/" class="btn btn-neutral" title="Accessing Virtual Machines"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/kubevirt/user-guide/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../accessing_virtual_machines/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../service_objects/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
